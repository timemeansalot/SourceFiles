---
title: 付杰周报-20230815
date: 2023-03-08 14:45:34
tags: RISC-V
---

[TOC]

# 协同仿真

## 协同仿真的过程

cosim 是怎么工作的呢？模拟器是软件实现的，它原子地执行一条条指令，同时记录下当前的状态，例如寄存器的取值、内存的状态等等。如果可以让 CPU 和模拟器锁步运行，也就是 CPU 执行一条指令，模拟器执行一条指令，然后比对状态，一旦出现不一致，就直接报错。但实际上 CPU 可能会更加复杂，因为它指令的执行拆分成了很多部分，需要针对流水线进行一些修改，使得它可以生成一个匹配模拟器的原子的执行流。

整体的工作流程如下：

1. 选择一个模拟器，自己写或者使用一个现成的。考虑到模拟器实现的功能和 CPU
   不一定一致，有时候需要修改模拟器的源码，所以可以考虑使用一些现成的开源软件，如果是为了 cosim 设计的就更好了。
2. 找到模拟器的单步执行接口，并且让模拟器可以把内部状态暴露出来。这一步可能需要修改源代码。
3. 修改 RTL，把指令的提交信息、寄存器堆的内容通过一些方法传递出来。
4. 修改仿真顶层，每当指令提交的时候，单步执行模拟器，然后比对双方的状态。

## Spike模拟器修改

> spike 实现了比较完整的 RISC-V 指令集，并且以库的形式提供了它的 API，但还需要一些修改，让它更加适合协同仿真:

1. step函数修改

   - spike 提供了 step 函数，就是我们想要的单步执行
   - 但是，spike 的 step 在遇到异常或者中断的时候也会返回，但实际上在处理器一侧，通常异常是单独处理的
   - 修改 spike 的 step 函数，如果遇到<u>异常</u>了，继续执行，直到执行了一条指令为止

2. pc修改:
   - spike 没有记录最后一次执行的指令的 pc，只记录了下一个 PC
   - 在发生<u>异常</u>的时候，就不会记录异常处理的第一条指令的 PC

## 处理器修改

> 需要修改处理器，让它可以汇报每个周期完成执行的指令情况，具体的格式因实现而异，最后都需要把这些信息暴露给仿真顶层，可能的方法有：

1. 通过<u>多级的 module output 一路传到顶层</u>，最终是顶层模块的输出信号。这种方法改动比较大，而且麻烦。
2. 通过 <u>DPI 函数</u>，每个周期调用一次，把信息通过 DPI 的参数传递给 C 函数。这种方法比较推荐。
3. 通过仿真器的功能，例如 verilator 可以通过添加注释的方法，把信号暴露出去。

## 执行cosim

> CPU 执行一条指令，就让模拟器也 step 一步，然后比较二者的状态

1. 比较寄存器堆跟CSR寄存器的方法:

   - 比较写入到寄存器堆的数据
   - 比较寄存器堆所有寄存器的值

2. 比较内存(data memory)，针对顺序处理器可以采用如下的方法比较：
   1. 把处理器读写的日志放到一个队列 deque 中
   2. 让模拟器也记录下内存的读写
   3. 从 deque 进行 pop 和比对

## 特殊情况处理

1. 外设:

   - 方法一：用 C 代码再写一个外设的模型，接到模拟器的虚拟总线上
   - 方法二：将处理器外设的读取发送给模拟器

2. **中断**：

   - 中断就会比较麻烦，因为中断的时机比较难保证同步
   - 把模拟器的中断处理关掉，当 CPU 发送 trap 的时候，让模拟器也发生一次 trap
   - MCU需要监控所有的中断，Difftest框架需要将中断发送给模拟器
   - 当多个中断同时发生时，Difftest框架需要根据优先级选择最高的中断发送给模拟器
   - Q: 目前我们的中断具体有哪些？软件、定时器、外部?
     ![](https://s2.loli.net/2023/09/08/wjJSCqhL9QkNPug.png)

# 参考文献

1. [单核处理器的协同仿真](https://jia.je/hardware/2023/03/23/core-cosim/)
2. [SMP-Difftest 支持多处理器的差分测试方法](https://github.com/OpenXiangShan/XiangShan-doc/blob/main/slides/20210624-RVWC-SMP-Difftest%20%E6%94%AF%E6%8C%81%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E5%B7%AE%E5%88%86%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.pdf)
3. [Co-simulation System](https://ibex-core.readthedocs.io/en/latest/03_reference/cosim.html)
