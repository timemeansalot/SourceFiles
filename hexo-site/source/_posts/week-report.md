[TOC]

# å¸¦å‹ç¼©æŒ‡ä»¤æ—¶å–æŒ‡éƒ¨åˆ†è®¾è®¡

**æ”¯æŒå‹ç¼©æŒ‡ä»¤æ—¶ï¼ŒIF Stage è®¾è®¡éœ€è¦è€ƒè™‘çš„è¦ç‚¹**ï¼š

1. å½“å‹ç¼©æŒ‡ä»¤è·Ÿæ•´æ•°æŒ‡ä»¤æ··åˆå­˜æ”¾çš„æ—¶å€™ï¼Œå¦‚ä½•å¤„ç†æ•´æ•°æŒ‡ä»¤å–æŒ‡é—®é¢˜ï¼Ÿ
   > ç”±äº RISC-V åœ¨æ”¯æŒå‹ç¼©æŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œ16bits çš„å‹ç¼©æŒ‡ä»¤è·Ÿ 32bits çš„æ•´æ•°æŒ‡ä»¤ï¼Œæ˜¯æ··åˆå­˜å‚¨çš„ï¼Œ
   > å› æ­¤æ•´æ•°æŒ‡ä»¤å¯èƒ½ä¸æ˜¯æŒ‰ç…§ 4B å¯¹é½çš„ï¼Œå¾®æ¶æ„éœ€è¦å¯¹æ•´æ•°æŒ‡ä»¤ä¸å¯¹é½çš„æƒ…å†µåšå¤„ç†ã€‚
2. å­˜åœ¨å‹ç¼©æŒ‡ä»¤çš„æ—¶å€™ï¼Œå¦‚ä½•å°† ID Stage çš„æŒ‡ä»¤è·ŸæŒ‡ä»¤å¯¹åº”çš„ PC ç›¸åŒ¹é…?
   > å› ä¸º SBP è®¡ç®— redirection_pc çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ° pc
   > pc å…¶å®æ˜¯å»ºç«‹çš„å¯¹å‹ç¼©ã€æ•´æ•°æŒ‡ä»¤çš„åˆ¤æ–­çš„åŸºç¡€ä¸Šçš„
3. å­˜åœ¨å‹ç¼©æŒ‡ä»¤çš„æ—¶å€™ï¼ŒIF é¡ºåºå–æŒ‡çš„æ—¶å€™å¦‚ä½•å¢åŠ  pc?
   > å–åˆ°å‹ç¼©æŒ‡ä»¤çš„æ—¶å€™ï¼Œpc+=2ï¼›å–åˆ°æ•´æ•°æŒ‡ä»¤çš„æ—¶å€™ pc+=4
4. SBP é¢„æµ‹è·³è½¬ï¼ŒALU éªŒè¯ä¸è·³è½¬çš„æ—¶å€™ï¼ŒEXE å¦‚ä½•è·å¾—æ­£ç¡®çš„ `pc_next_next` å‘é€ç»™ IFï¼Ÿ

   1. ID Stage çš„ SBP é¢„æµ‹è·³è½¬æ—¶ï¼Œä¼šå°† IF çš„å–æŒ‡åœ°å€ä¿®æ”¹ä¸º prediction_addr
   2. EXE Stage çš„ ALU å¦‚æœåˆ¤æ–­ä¸è·³è½¬ï¼Œéœ€è¦å°† IF çš„å–æŒ‡åœ°å€æ›´æ”¹ä¸º pc_next_next,
      å¹¶ä¸”å†²åˆ·åˆ° prediction_addr å–å‡ºçš„æŒ‡ä»¤

   ![sbp taken, alu not taken](/Users/fujie/Pictures/typora/IF/sbtTaluN.svg)

## æ–¹æ¡ˆ 1

**æ ¸å¿ƒæ€æƒ³**ï¼šé‡‡ç”¨ 32 ä½å®½çš„ SRAMï¼Œæ¯æ¬¡å–æŒ‡ 4B çš„æ•°æ®ï¼Œé‡‡ç”¨ leftover buffer å­˜å‚¨ä¸Šæ¬¡å–æŒ‡çš„é«˜ 16bitsï¼Œç”¨äºåˆ¤æ–­æŒ‡ä»¤æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤ã€å®Œæˆ 32bits æŒ‡ä»¤çš„æ‹¼æ¥

> å‚è€ƒäº†èœ‚é¸Ÿçš„è®¾è®¡ã€ä»¥åŠè®ºæ–‡ã€Šç”¨äºè®¡é‡çš„åµŒå…¥å¼ RISC-V å¤„ç†å™¨è®¾è®¡åŠ MCU å®ç°ã€‹

![å‹ç¼©æŒ‡ä»¤ä¸æ•´æ•°æŒ‡ä»¤å­˜å‚¨ç»„åˆ](https://s2.loli.net/2023/05/23/OSDrPmAwNLc5iF7.png)
![å‹ç¼©æŒ‡ä»¤è¯‘ç å™¨æŒ‡ä»¤åˆ¤åˆ«æµç¨‹å›¾](https://s2.loli.net/2023/05/23/XS4AhVs71Wmwl6r.png)

1. leftover buffer çš„ä½œç”¨ï¼š

   1. å­˜å‚¨ 32bits æŒ‡ä»¤çš„ä½ 16bits æ•°æ®
   2. åˆ¤æ–­å‹ç¼©æŒ‡ä»¤å’Œæ•´æ•°æŒ‡ä»¤çš„æ ‡å¿—

2. è¯¥æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼šé¡ºåºå–æŒ‡çš„æ—¶å€™ï¼ŒPC+=4 å³å¯; å–æŒ‡å•ä½ 4Bï¼ŒPC æœ€åä¸¤ä½å–æŒ‡çš„æ—¶å€™ç›´æ¥å½“`00`æ¥å¤„ç†
3. è¯¥æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š
   1. å‹ç¼©æŒ‡ä»¤è·Ÿæ•´æ•°æŒ‡ä»¤çš„ç»„åˆä¸€å…±æœ‰ 5 ç§ï¼Œæ¯æ¬¡å– 4B æ•°æ®ä¹‹åï¼Œéƒ½éœ€è¦ç»è¿‡å¤æ‚çš„åˆ¤æ–­æ‰å¯ä»¥åˆ¤æ–­å‡ºæŒ‡ä»¤çš„ç§ç±»
   2. 32bits æŒ‡ä»¤ä¸å¯¹é½çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è·Ÿ leftover buffer ä¸­çš„æ•°æ®æ‹¼æ¥æ‰å¯ä»¥å¾—åˆ°çœŸæ­£çš„æ•´æ•°æŒ‡ä»¤
   3. å°†æŒ‡ä»¤ä¸å…¶å¯¹åº”çš„ pc å¯¹åº”ä¸æ–¹ä¾¿ï¼ˆå› ä¸ºæŒ‡ä»¤å¯èƒ½ä¸æ˜¯ç›´æ¥æŒ‰ç…§ pc ä» SRAM ä¸­å–å‡ºæ¥çš„ï¼Œè€Œæ˜¯è·Ÿ leftover buffer æ‹¼æ¥è€Œæˆçš„ï¼‰
   4. åœ°å€é‡å®šå‘å‘ç”Ÿçš„æ—¶å€™ï¼Œå¦‚æœé‡å®šå‘åœ°å€ä¸æ˜¯ 4B å¯¹é½çš„ï¼Œéœ€è¦ 2 æ¬¡è®¿é—® SRAM æ‰å¯ä»¥æ‹¼æˆä¸€ä¸ªæ•´æ•°æŒ‡ä»¤

## æ–¹æ¡ˆ 2

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æ–¹æ¡ˆ 1 çš„åŸºç¡€ä¸Šï¼Œå°† 32bits çš„ SRAM æ‹†åˆ†æˆ 2 å— 16bits çš„ SRAMï¼Œè¿™æ ·å–æŒ‡çš„ç²’åº¦ä» 4B å˜æˆäº† 2B

![](/Users/fujie/Pictures/typora/IF/method2.svg)

1. æ•´æ•°æŒ‡ä»¤å¯¹é½ï¼šåˆ©ç”¨ 2 back SRAM æ¥å¤„ç†éå¯¹é½åœ°å€ï¼Œå–æŒ‡çš„æ—¶å€™ï¼Œæ ¹æ® addr æ˜¯å¦ 4B å¯¹é½ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µ
   1. addr æ˜¯ 4B å¯¹é½ï¼š`instr={Left[addr>>2], Right[addr>>2]}`, å¦‚å›¾ pc==8 çš„æƒ…å†µ
   2. addr æ˜¯ 2B å¯¹é½ï¼š`instr={Left[Right[addr>>2+1], Left[addr>>2]}`ï¼Œå¦‚å›¾ pc==2 çš„æƒ…å†µ
      ![](/Users/fujie/Pictures/typora/IF/method2Sram.svg)
2. å‹ç¼©æŒ‡ä»¤åˆ¤æ–­ï¼Œç”±äºä¸å­˜åœ¨ leftover bufferï¼Œåˆ¤æ–­å‹ç¼©æŒ‡ä»¤ä¸æ•´æ•°æŒ‡ä»¤ï¼Œåªéœ€è¦çœ‹ instr[1:0]å³å¯,
   ä¸Šå›¾ä¸­çº¢è‰²éƒ¨åˆ†å°±æ˜¯åœ¨ ID é˜¶æ®µé€šè¿‡æ¯”è¾ƒæŒ‡ä»¤æœ€ä½ 2bits æ¥åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤

   1. `instr[1:0]==11`: pc+=4
   2. `instr[1:0]!=11`: pc+=2

   å–å‡ºçš„æŒ‡ä»¤`instr`å¯èƒ½çš„æƒ…å†µä¸€å…±æœ‰ 3 ç§ï¼š`I`, `C+C`, `I+C`,
   é’ˆå¯¹ `C+C` çš„æƒ…å†µï¼Œå½“ä½œ `I+C` å¤„ç†ï¼Œä»¥ç®€åŒ–æµæ°´çº¿å†²åˆ·çš„é€»è¾‘(ä»£ä»·æ˜¯ `C+C` æœ¬å¯ä»¥åªè®¿é—®ä¸€æ¬¡ SRAM çš„)ã€‚

   > 32bits çš„å‹ç¼©æŒ‡ä»¤ï¼Œä¸ç®¡æ˜¯`C+C`è¿˜æ˜¯`I+C`ï¼Œé€åˆ° ID çš„ extending unit(EU)ä¹‹åï¼ŒEU éƒ½ä¼šå°†å…¶ä½ 16bits å‹ç¼©æŒ‡ä»¤éƒ¨åˆ†æ‰©å±•æˆå¯¹åº”çš„ 32bits æ•´æ•°æŒ‡ä»¤

3. å¦‚ä½•åŒ¹é…æ¯æ¡æŒ‡ä»¤å’Œå¯¹åº”çš„ pc:  
   åœ¨ IF Stage å–æŒ‡çš„æ—¶å€™ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯æŒ‰ç…§ pc_sel å–æŒ‡çš„ï¼Œå› æ­¤æ¯æ¡æŒ‡ä»¤éƒ½å¯¹åº” pc_sel çš„å€¼
4. pc_next_next å¦‚ä½•è®¡ç®—ï¼š
   ç”±äºå‹ç¼©æŒ‡ä»¤ã€æ•´æ•°æŒ‡ä»¤æ··åˆå­˜å‚¨ï¼Œå› æ­¤ pc_next_next çš„å€¼ä¾èµ–äºå½“å‰æŒ‡ä»¤ä»¥åŠåç»­é‚£æ¡æŒ‡ä»¤çš„ç±»å‹ï¼Œ
   å‡è®¾æŒ‡ä»¤åºåˆ—ä¸º 3->2->1ï¼Œä»¤æŒ‡ä»¤ 1 å¯¹åº”çš„åœ°å€ä¸º pc

   1. è®¡ç®— pc_next:
      - æŒ‡ä»¤ 1 æ˜¯å‹ç¼©æŒ‡ä»¤ï¼špc_next=pc+2
      - æŒ‡ä»¤ 1 ä¸æ˜¯å‹ç¼©æŒ‡ä»¤ï¼špc_next=pc+4
   2. è®¡ç®— pc_next_next:
      - æŒ‡ä»¤ 2 æ˜¯å‹ç¼©æŒ‡ä»¤ï¼špc_next_next=pc_next+2
      - æŒ‡ä»¤ 2 ä¸æ˜¯å‹ç¼©æŒ‡ä»¤ï¼špc_next_next=pc_next+4

5. è¯¥æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š
   1. æ²¡æœ‰ leftover bufferï¼Œå‹ç¼©æŒ‡ä»¤åˆ¤è¯»å˜å¾—ç®€å•ã€32bits æŒ‡ä»¤ä¹Ÿä¸éœ€è¦æ‹¼æ¥
   2. å°†æŒ‡ä»¤è·Ÿ PC å¯¹åº”å¾ˆç®€å•ï¼ŒæŒ‡ä»¤å¯¹åº”çš„ PC ä¸€å®šæ˜¯ pc_sel
   3. åœ°å€é‡å®šå‘å‘ç”Ÿçš„æ—¶å€™ï¼Œå³ä½¿ PC ä¸æ˜¯ 4B å¯¹é½ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ª cycle å°±ä» SRAM ä¸­å–å‡ºæŒ‡ä»¤
6. è¯¥æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š
   1. IF é˜¶æ®µè®¡ç®— pc_next çš„é€»è¾‘ä¾èµ–äº**å¯¹å–å‡ºçš„æŒ‡ä»¤çš„åˆ¤æ–­**ï¼Œä»è€Œåˆ¤æ–­ pc_next ç­‰äº pc+4 è¿˜æ˜¯ pc+2
   2. ä¸¤ä¸ªç›¸é‚»çš„å‹ç¼©æŒ‡ä»¤(`C+C`ç±»å‹)ï¼Œæ˜æ˜å¯ä»¥è®¿é—® 1 æ¬¡ SRAMï¼Œä½†æ˜¯å´éœ€è¦è®¿é—® 2 æ¬¡

## æ–¹æ¡ˆ 3

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æ–¹æ¡ˆ 2 çš„åŸºç¡€ä¸Šï¼Œå°†å–å‡ºçš„æŒ‡ä»¤ instr æ”¾åˆ° FIFO ä¸­ï¼ŒèŠ‚çº¦`C+C`ç±»å‹æŒ‡ä»¤å­˜å‚¨çš„è®¿é—® SRAM

> Q: æ˜¯å¦ 4\*16 çš„ FIFO ä¹Ÿèƒ½ä¿è¯æ²¡æœ‰ overflow?

![](/Users/fujie/Pictures/typora/IF/method3.svg)

1. æ•´æ•°æŒ‡ä»¤å¯¹é½ï¼šå–æŒ‡é€»è¾‘è·Ÿæ–¹æ¡ˆ 2 ç›¸åŒï¼Œå·®åˆ«åœ¨äºï¼š
   1. å–å‡ºçš„æŒ‡ä»¤æ”¾åˆ° FIFO ä¸­ï¼Œè€Œä¸æ˜¯æ”¾åˆ° IF/ID pipeline register ä¸­
   2. FIFO æ²¡æœ‰ç©ºé—´çš„æ—¶å€™ï¼Œä¸ä¼šä» I-Memory ä¸­å–æŒ‡ä»¤æ”¾åˆ° FIFO ä¸­
2. FIFO é€»è¾‘(Question -> FIFO å®¹é‡ä¸º 4 èƒ½å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ)
   1. é¿å… underflowï¼šç”±äº ID ä¸€æ¬¡æœ€å¤šå–èµ° 32bits çš„æ•°æ®ï¼Œå› æ­¤ FIFO $count \le 2$ çš„æ—¶å€™ï¼ŒFIFO å…è®¸å†™å…¥
   2. é¿å… overflowï¼šè‹¥ä»¤ FIFO æ€»å®¹é‡ä¸º 4ï¼Œåˆ™ FIFO $count\ge3$ æ—¶ï¼ŒFIFO ä¸èƒ½å†™å…¥
3. å‹ç¼©æŒ‡ä»¤åˆ¤æ–­ï¼šä» FIFO å¤´éƒ¨å–å‡º 32bits çš„æŒ‡ä»¤é€åˆ° IDï¼Œæœ‰ ID Stage æ¯”è¾ƒæŒ‡ä»¤æœ€ä½ 2bits æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤
   1. å¦‚æœæ˜¯å‹ç¼©æŒ‡ä»¤ï¼Œåˆ™ FIFO å°†å¤´éƒ¨ 16bits æŒ‡ä»¤ popï¼ŒFIFO å®¹é‡-1
   2. å¦‚æœæ˜¯æ•´æ•°æŒ‡ä»¤ï¼Œåˆ™ FIFO å°†å¤´éƒ¨ 32bits æŒ‡ä»¤ popï¼ŒFIFO å®¹é‡-2
4. å¦‚ä½•åŒ¹é…æ¯æ¡æŒ‡ä»¤å’Œå¯¹åº”çš„ pc:
   1. æ–¹æ¡ˆ 3 ä¸­ï¼Œå–æŒ‡çš„ pc è·Ÿæ¯æ¡æŒ‡ä»¤çš„ pc ä¸æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå–æŒ‡ pc åªè´Ÿè´£åœ¨ FIFO æœ‰ç©ºé—´çš„æ—¶å€™ï¼Œ
      é¡ºåºçš„å–æŒ‡æ”¾å…¥åˆ° FIFO ä¸­
   2. æ–¹æ¡ˆ 3 ä¸­æ¯æ¡æŒ‡ä»¤å¯¹åº”çš„ PC åœ¨ ID Stage ä¸­ç»´æŠ¤ï¼ŒID Stage åªä¼šåœ¨ reset æˆ–è€…é‡å®šå‘å‘ç”Ÿçš„æ—¶å€™ï¼Œ
      æ‰ä¼šä» IF å¾—åˆ° pc
5. pc_next_next å¦‚ä½•è®¡ç®—ï¼Ÿè·Ÿæ–¹æ¡ˆ 2 ä¸åŒå¤„æœ‰ï¼š
   1. æ–¹æ¡ˆ 3 åœ¨ ID Stage å†åˆ¤æ–­æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤ï¼Œæ‰€ä»¥ pc_next åœ¨ ID Stage è®¡ç®—å¾—åˆ°
   2. pc_next_next åœ¨ EXE Stage è®¡ç®—å¾—åˆ°
6. è¯¥æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š
   1. å–æŒ‡çš„ pc ä¸éœ€è¦åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤ï¼Œé»˜è®¤+4 å³å¯
   2. é’ˆå¯¹`C+C`ç±»å‹çš„æŒ‡ä»¤ï¼Œåªç”¨è®¿é—® SRAM ä¸€æ¬¡
7. è¯¥æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š
   1. æŒ‡ä»¤è·Ÿå–æŒ‡ pc å¯¹åº”é€»è¾‘æ¯”è¾ƒå¤æ‚
   2. ç›¸æ¯”äºæ–¹æ¡ˆ 2ï¼Œè®¡ç®— pc_next_next éœ€è¦é¢å¤–åœ¨ EXE Stage å¤šå¼•å…¥ä¸€ä¸ªåŠ æ³•å™¨
   3. IF Stage å¼•å…¥äº† FIFOï¼Œå¢åŠ äº†å¤æ‚åº¦

## ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

1. æ–¹æ¡ˆ 1 çš„è®¾è®¡æ˜¯æœ€ç®€å•çš„ï¼Œå…¶æ˜æ˜¾çš„ç¼ºç‚¹åœ¨äºï¼š
   1. å‹ç¼©æŒ‡ä»¤è·Ÿæ•´æ•°æŒ‡ä»¤çš„ç»„åˆå¤æ‚ï¼Œå› æ­¤åˆ¤æ–­é€»è¾‘ä¹Ÿå¾ˆå¤æ‚
   2. é‡å®šå‘å‘ç”Ÿçš„æ—¶å€™ï¼Œå¦‚æœ redirection_pc ä¸æ˜¯ 4B å¯¹é½çš„ï¼Œéœ€è¦ 2 æ¬¡è®¿å­˜æ‰å¯ä»¥å–åˆ°æ•´æ•°æŒ‡ä»¤
2. æ–¹æ¡ˆ 2 åœ¨æ–¹æ¡ˆ 1 çš„åŸºç¡€ä¸Šå°† 1 bank sram æ”¹è¿›ä¸º 2 bank sram
   1. è§£å†³äº†æ–¹æ¡ˆ 1 ä¸­æ˜æ˜¾çš„ç¼ºç‚¹
   2. ä»ç„¶å­˜åœ¨çš„é—®é¢˜åœ¨äºï¼šå–æŒ‡ pc çš„è®¡ç®—ï¼Œéœ€è¦åˆ¤æ–­ä» I-Memory ä¸­å–å‡ºçš„æŒ‡ä»¤æ˜¯å¦æ˜¯å‹ç¼©æŒ‡ä»¤
3. æ–¹æ¡ˆ 3 åœ¨æ–¹æ¡ˆ 2 çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥äº† FIFOï¼Œå¹¶ä¸”å°†å‹ç¼©æŒ‡ä»¤çš„åˆ¤æ–­æ¨è¿Ÿåˆ°äº† ID Stage
   1. å–æŒ‡ pc ä¸ç”¨ä¾èµ–äºæŒ‡ä»¤çš„ç±»å‹
   2. ä»˜å‡ºçš„ä»£ä»·æ˜¯
      1. FIFO å¸¦æ¥çš„å¤æ‚åº¦
      2. æŒ‡ä»¤è·Ÿ pc çš„å¯¹åº”å…³ç³»ï¼Œå˜å¾—æ¯”æ–¹æ¡ˆ 2 å¤æ‚
      3. éœ€è¦åœ¨ EXE é˜¶æ®µå¢åŠ é¢å¤–çš„åŠ æ³•å™¨æ¥è®¡ç®— pc_next_next

> ç»¼ä¸Šï¼šå¦‚æœæš‚æ—¶æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–¹æ¡ˆ 2ã€3 ä¹‹é—´é€‰æ‹©ä¸€ä¸ª

## å–æŒ‡æ—¶å¯èƒ½æ›´æ–°çš„ PC å€¼

![redirectionSrc](/Users/fujie/Pictures/typora/IF/redirectionSrc.svg)

IF Stage å¯èƒ½çš„å–æŒ‡åœ°å€æœ‰å¦‚ä¸‹ä¸€äº›æƒ…å†µï¼Œå…¶ä¼˜å…ˆçº§ï¼š`TOP > EXE > ID > IF`

1. TOP: reset_addr å¯ä»¥ç”± TOP ä¼ ç»™ IF Stageï¼Œä¹Ÿå¯ä»¥åœ¨ IF Stage é‡Œé»˜è®¤ä¸€ä¸ª reset_addr
2. IF Stage: pc_register çš„è¾“å‡º
3. ID Stage: SBP åˆ¤æ–­è·³è½¬å‘ç”Ÿæ—¶ï¼Œå¯¹åº”çš„è·³è½¬åœ°å€
4. EXE Stage:

   - ALU åˆ¤æ–­ SBP é¢„æµ‹é”™è¯¯æ—¶ï¼Œéœ€è¦ç»™å‡º redirection_pc
   - CSR

     1. mret æŒ‡ä»¤ï¼Œéœ€è¦å°† epc çš„åœ°å€ä½œä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€
     2. éæ³•æŒ‡ä»¤ï¼Œéœ€è¦è·³è½¬åˆ° trap_vector åœ°å€
     3. å¤–éƒ¨ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œéœ€è¦è·³è½¬åˆ° trap_vector åœ°å€
     4. debug å‘ç”Ÿæ—¶ï¼Œéœ€è¦è·³åˆ° debug å¯¹åº”åœ°å€

     > PS: æ ¹æ® CSR è®¾è®¡ä¸åŒï¼Œä¸Šè¿°å››ä¸ª addr å¯èƒ½ä¼šå­˜åœ¨ç›¸åŒçš„æƒ…å†µ

# è®¿å­˜çº§ Load/Store æŒ‡ä»¤è®¾è®¡

## ä¿¡å·å®šä¹‰

1. è¾“å…¥åˆ° D-Memory çš„ä¿¡å·

   | ä¿¡å·                  | æè¿°                  |
   | --------------------- | --------------------- |
   | dmem_addr[31:0]       | D-Memory è®¿å­˜åœ°å€     |
   | dmem_write_data[31:0] | D-Memory å†™å…¥çš„æ•°æ®   |
   | dmem_write_mask[3:0]  | D-Memory å†™å…¥æ—¶çš„æ©ç  |
   | dmem_rw               | è¯»å†™é€‰æ‹©ï¼Œ0:è¯»ï¼Œ1:å†™  |
   | valid/ready           | æ¡æ‰‹ä¿¡å·              |

_å¦‚æœæŒ‡ä»¤ä¸éœ€è¦è®¿é—® D-Memoryï¼Œå¯ä»¥ä»¤ RW=1, dmem_write_mask=0000_

> Q: D-Memory æ˜¯å¦éœ€è¦ reset ä¿¡å·ï¼Ÿæœ‰ä¸€äº›é¡¹ç›®é‡Œæœ‰è¿™ä¸ªä¿¡å·ã€æœ‰äº›é¡¹ç›®é‡Œæ²¡æœ‰

2. æ¥è‡ª D-Memory çš„ä¿¡å·

   1. dmem_read_data[31:0]: data read from D-Memory, this data may need be future modified
   2. valid/ready: valid when memory is ready to get address and contorl,
      ready when memory response data is ready
   3. error: memory access error

   | ä¿¡å·                 | æè¿°                 |
   | -------------------- | -------------------- |
   | dmem_read_data[31:0] | D-Memory è¯»å‡ºçš„æ•°æ®  |
   | valid/ready          | æ¡æ‰‹ä¿¡å·             |
   | error                | è®¿å­˜å¤±è´¥æ—¶çš„åé¦ˆä¿¡å· |

> è®¿å­˜å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦å‘ŠçŸ¥ EXE Stage çš„ CSR è¿›å…¥è®¿å­˜å¤±è´¥çš„å¼‚å¸¸å¤„ç†ç¨‹åº

**ç”±äºå½“å‰è®¾è®¡çš„ D-Memory åªæ˜¯ MEM Stage çš„ä¸€å—å†…å­˜ï¼Œå› æ­¤ valid, ready, error ä¿¡å·éƒ½æ²¡æœ‰å¯ç”¨**

3. æ¥è‡ª EXE Stage çš„æµæ°´çº¿è¾“å…¥

   | ä¿¡å·                   | æè¿°                                           |
   | ---------------------- | ---------------------------------------------- |
   | rs1_e_i[31:0]          | D-Memory çš„å†™å…¥æ•°æ®(wire)                      |
   | dmem_type_e_i[3:0]     | D-Memory çš„è®¿å­˜ç±»å‹(wire)                      |
   | alu_result_e_i[31:0]   | ALU è®¡ç®—çš„ç»“æœ(wire)                           |
   | extended_imm_e_i[31:0] | æ‹“å±•ä¸º 32bits çš„ç«‹å³æ•°éƒ¨åˆ†ï¼ŒLUI æŒ‡ä»¤çš„å†™å›æ•°æ® |
   | pc_plus4_e_i[31:0]     | pc+4 çš„æ•°æ®ï¼ŒJAL, JALR æŒ‡ä»¤çš„å†™å›æ•°æ®          |
   | result_src_e_i[1:0]    | å¯„å­˜å™¨å†™å›æ•°æ®æ¥æºé€‰æ‹©ä¿¡å·                     |
   | rd_idx_e_i[4:0]        | è¢«å†™å›çš„å¯„å­˜å™¨çš„ä¸‹æ ‡                           |
   | reg_write_en_e_i       | å¯„å­˜å™¨å†™å›ä½¿èƒ½                                 |

   **ç”±äº D-Memory è®¿å­˜æœ‰ä¸€ä¸ª cycle å»¶è¿Ÿï¼Œæ‰€ä»¥ alu_result_e_i, dmem_type_e_i éƒ½æ˜¯ wire ç±»å‹**

4. åˆ° WB stage çš„æµæ°´çº¿è¾“å‡º

   | ä¿¡å·                      | æè¿°                                                 |
   | ------------------------- | ---------------------------------------------------- |
   | alu_result_m_o[31:0]      | ALU è®¡ç®—çš„ç»“æœ(wire), alu_result_e_i å¯„å­˜ 2 æ‹çš„ç»“æœ |
   | extended_imm_m_o[31:0]    | æ‹“å±•ä¸º 32bits çš„ç«‹å³æ•°éƒ¨åˆ†ï¼ŒLUI æŒ‡ä»¤çš„å†™å›æ•°æ®       |
   | pc_plus4_m_o[31:0]        | pc+4 çš„æ•°æ®ï¼ŒJAL, JALR æŒ‡ä»¤çš„å†™å›æ•°æ®                |
   | ğŸŒŸmem_read_data_m_o[31:0] | ä» D-Memory ä¸­è¯»å‡ºçš„æ•°æ®ï¼ŒLoad æŒ‡ä»¤çš„å†™å›æ•°æ®        |
   | result_src_m_o[1:0]       | å¯„å­˜å™¨å†™å›æ•°æ®æ¥æºé€‰æ‹©ä¿¡å·                           |
   | rd_idx_m_o[4:0]           | è¢«å†™å›çš„å¯„å­˜å™¨çš„ä¸‹æ ‡                                 |
   | reg_write_en_m_o          | å¯„å­˜å™¨å†™å›ä½¿èƒ½                                       |

   **alu_result_e_i ä½œä¸ºå†™å›æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦å¤šæš‚å­˜ä¸€æ‹ä»¥è·Ÿå…¶ä»–å†™å›ä¿¡å·åŒæ­¥**

## è®¿å­˜é€»è¾‘

æœ¬éƒ¨åˆ†ä¸»è¦ä»‹ç» Load/Store æŒ‡ä»¤åœ¨ MEM Stage å…·ä½“çš„å®ç°é€»è¾‘ã€‚

> ç”±äº CSR æ¨¡å—æ”¾åˆ° MEM Stage ä¼šå¯¼è‡´æµæ°´çº¿åˆ·æ–°é€»è¾‘æ¶‰åŠåˆ°æ›´å¤šä¸€ä¸ª Stageï¼Œå¯¼è‡´åˆ·æ–°é€»è¾‘å˜å¾—å¤æ‚ï¼Œ
> å› æ­¤è€ƒè™‘å°† CSR æ¨¡å—æ”¾åˆ° EXE Stageï¼Œå¹¶ä¸”åœ¨ EXE Stage å¯¹è®¿å­˜æŒ‡ä»¤åœ°å€ä¸å¯¹é½çš„æƒ…å†µè§¦å‘ exception

1. LB, LBU, SB æŒ‡ä»¤ç”±äºå…¶æ“ä½œçš„æ˜¯ 1B çš„æ•°æ®ï¼Œå› æ­¤ä¸ä¼šå‡ºç° address misaligned exception
2. LH, LHU, SH æŒ‡ä»¤ï¼Œ`addr[0]!=0`æ—¶ï¼Œä¼šå‡ºç° address misaligned exception
3. LW, SW æŒ‡ä»¤ï¼Œ`addr[1:0]!=00`æ—¶ï¼Œä¼šå‡ºç° address misaligned exception

### Load æŒ‡ä»¤

1.  æ¶‰åŠåˆ°çš„æŒ‡ä»¤ï¼š`LB, LBU, LH, LHU, LW`
2.  D-Memory å†™å…¥åœ°å€ï¼šdmem_addr = alu_result_e_i;
3.  è¯»å†™ç±»å‹ï¼šdmem_rw = 1'b0;
4.  ä» D-Memory è¯»å‡ºçš„æ•°æ® `dmem_read_data` è·Ÿè¾“å‡ºåˆ° WB Stage æ•°æ® `mem_read_data_m_o` çš„å…³ç³»

    > æ ¹æ® Load æŒ‡ä»¤çš„ç±»å‹åŠè®¿å­˜åœ°å€æœ€åä¸¤ä½çš„åœ°å€ï¼Œæ‰©å±• D-Memory çš„è¾“å‡ºæ•°æ®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

    | mem_read_data_m_o                                   | mem_type | addr[1:0] |
    | --------------------------------------------------- | -------- | --------- |
    | `{{24{dmem_read_data[7]}}, dmem_read_data[7:0]}`    | MEM_LB   | 00        |
    | `{{24{dmem_read_data[15]}},dmem_read_data[15:8]}`   | MEM_LB   | 01        |
    | `{{24{dmem_read_data[23]}},dmem_read_data[23:16]}`  | MEM_LB   | 10        |
    | `{{24{dmem_read_data[31]}},dmem_read_data[31:24]}`  | MEM_LB   | 11        |
    | `{{24{1'b0} ,dmem_read_data[7:0]}`                  | MEM_LBU  | 00        |
    | `{{24{1'b0} ,dmem_read_data[15:8]}`                 | MEM_LBU  | 01        |
    | `{{24{1'b0} ,dmem_read_data[23:16]}`                | MEM_LBU  | 10        |
    | `{{24{1'b0} ,dmem_read_data[31:24]}`                | MEM_LBU  | 11        |
    | `{{16{dmem_read_data[15]}}, dmem_read_data[15: 0]}` | MEM_LH   | 00        |
    | `{{16{dmem_read_data[31]}}, dmem_read_data[31:16]}` | MEM_LH   | 10        |
    | `{{16{1'b0}, dmem_read_data[15:0]}`                 | MEM_LHU  | 00        |
    | `{{16{1'b0}, dmem_read_data[31:16]}`                | MEM_LHU  | 10        |
    | dmem_read_data                                      | MEM_LW   | 00        |

### Store æŒ‡ä»¤

1. æ¶‰åŠåˆ°çš„æŒ‡ä»¤ï¼š`SB, SH, SW`
2. D-Memory å†™å…¥åœ°å€ï¼šdmem_addr = alu_result_e_i;
3. è¯»å†™ç±»å‹ï¼šdmem_rw = 1'b1;
4. å†™å…¥æ©ç : dmem_write_mask

   > å†™å…¥æ©ç ä¸»è¦æ ¹æ® Load æŒ‡ä»¤ç±»å‹å’Œè®¿å­˜åœ°å€ï¼Œæ¥æ§åˆ¶å†™å…¥åˆ° D-Memory çš„å“ªäº› byteã€‚
   > D-Memory éœ€è¦æ”¯æŒæ©ç æ“ä½œã€‚

   | dmem_write_mask | mem_type        | addr[1:0] |
   | --------------- | --------------- | --------- |
   | 0001            | MEM_SB, MEM_SBU | 00        |
   | 0010            | MEM_SB, MEM_SBU | 01        |
   | 0100            | MEM_SB, MEM_SBU | 10        |
   | 1000            | MEM_SB, MEM_SBU | 11        |
   | 0011            | MEM_SH, MEM_SHU | 0x        |
   | 1100            | MEM_SH, MEM_SHU | 1x        |
   | 1111            | MEM_SW          | xx        |

5. å†™å…¥åˆ° D-Memory çš„æ•°æ®ï¼šdmem_write_data

   `dmem_write_data[31:0]`æ˜¯å†™å…¥åˆ° D-Memory ä¸­çš„æ•°æ®, `rs1_e_i` æ˜¯ EXE Stage è¾“å…¥çš„ä»£å†™å…¥åˆ° D-Memory çš„æ•°æ®

   | dmem_write_data                         | mem_type | addr[1:0] |
   | --------------------------------------- | -------- | --------- |
   | `{{24{1'b0}}, rs1_e_i[7:0]}`            | MEM_SB   | 00        |
   | `{{16{1'b0}}, rs1_e_i[7:0], {8{1'b0}}}` | MEM_SB   | 01        |
   | `{{8{1'b0}}, rs1_e_i[7:0], {16{1'b0}}}` | MEM_SB   | 10        |
   | `{rs1_e_i[7:0], {24{1'b0}}}`            | MEM_SB   | 11        |
   | `{{16{1'b0}}, rs1_e_i[15:0]}`           | MEM_SH   | 0x        |
   | `{rs1_e_i[15:0], {16{1'b0}}}`           | MEM_SH   | 1x        |
   | rs1_e_i                                 | MEM_SW   | xx        |

### éè®¿å­˜æŒ‡ä»¤

1. è¯»å†™ç±»å‹ï¼šdmem_rw = 1'b1;
2. å†™å…¥æ©ç : dmem_write_mask=4'b0000;

# riscv-tests ç¯å¢ƒæ­å»º

1. éªŒè¯ç›®å½•

   ```bash
    src
    â”œâ”€â”€ rtl
    â”‚Â Â  â”œâ”€â”€ top.v
    â”‚Â Â  â”œâ”€â”€ ...
    â”‚Â Â  â”œâ”€â”€ ...
    â”‚Â Â  â”œâ”€â”€ top_tb.v
    â””â”€â”€ verification
        â”œâ”€â”€ Makefile
        â”œâ”€â”€ asm
        â””â”€â”€ rtl
   ```

   1. ç›®å‰æ‰€æœ‰çš„æºæ–‡ä»¶éƒ½åœ¨é¡¹ç›®çš„`src`æ–‡ä»¶ä¸‹
   2. `src/rtl`å­˜æ¡£ MCU çš„ verilog ä»£ç 
   3. `src/verification`æ˜¯ä½¿ç”¨ riscv-tests å¯¹ rtl ä»£ç è¿›è¡ŒéªŒè¯çš„ç›®å½•
      1. `asm`ï¼šå­˜æ”¾æ‰€æœ‰çš„ riscv-tests çš„æ±‡ç¼–æµ‹è¯•æ–‡ä»¶
      2. `rtl`ï¼šå­˜æ”¾æ‰€æœ‰çš„å¸¦æµ‹è¯•çš„ verilog æºæ–‡ä»¶
      3. `Makefile`ï¼šå­˜æ”¾æ‰€æœ‰éªŒè¯æ—¶éœ€è¦çš„ä¸€äº›å‘½ä»¤ï¼Œå¦‚â€œç¼–è¯‘ verilogâ€ã€â€œç¼–è¯‘æ±‡ç¼–æ–‡ä»¶â€ã€â€œä»¿çœŸâ€ç­‰

2. Makefile å†…å®¹

   ```Makefile
   .DEFAULT_GOAL := wave
   # compile asm source file to get test cases for MCU
   asmCode:
   	@(cd asm && ./clean.sh && ./regen.sh && cd ..)
   # copy source file before compile
   copy:
   	@(rm -rf rtl/*.v && cp ../rtl/*.v rtl)
   # simulate DUT, you'd better `make asmCode` first to generated machine code
   sim:
   	@(cd rtl && make sim)
   # show waveform
   wave:
   	@(cd rtl && make waveform)

   # regression test
   # TODO: implement in the future.
   # Because MCU can't pass even one test file in riscv-tests now!
   # So we don't need to test the whole riscv-tests now.
   clean:
   	@(cd asm && ./clean.sh && cd ../rtl/ && make clean)
   # declare phone target
   PHONY: clean wave sim copy asmCode
   ```

   1. asmCode: ä¼šè¿›å…¥åˆ° asm æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”è°ƒç”¨è„šæœ¬`regen.sh`ç¼–è¯‘æ‰€æœ‰çš„ riscv-tests æ–‡ä»¶ï¼Œå¹¶ä¸”å¾—åˆ°æœºå™¨ç ;  
      testbench ä¼šä»å¾—åˆ°çš„æœºå™¨ç æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æŒ‡ä»¤åˆ° I-Memory ä¸­
   2. copyï¼šç”¨`src/rtl`ä¸‹å¤åˆ¶æ‰€æœ‰çš„`.v`æ–‡ä»¶æ›¿æ¢`verification/rtl`ç›®å½•ä¸‹çš„æ‰€æœ‰`.v`æ–‡ä»¶
   3. simï¼šä¼šè¿›å…¥`verification/rtl`ç›®å½•ä¸‹ï¼Œå¹¶ä¸”ä½¿ç”¨ make sim å‘½ä»¤ï¼Œ
      è¯¥å‘½ä»¤ä¼šç¼–è¯‘ rtl æ–‡ä»¶ï¼Œå†æ‰§è¡Œ rtl ä»¿çœŸ
   4. waveï¼šä½¿ç”¨ gtkWave æŸ¥çœ‹ä»¿çœŸç”Ÿæˆçš„æ³¢å½¢
   5. regression test: ä½¿ç”¨æ‰€æœ‰çš„ riscv-tests æµ‹è¯•ç”¨ä¾‹æµ‹è¯• MCUï¼Œ
      å¦‚æœéƒ½é€šè¿‡äº†åˆ™è¯´æ˜ MCU é€šè¿‡äº† riscv-tests æµ‹è¯•;  
      ä½†æ˜¯ç°åœ¨çš„ MCU ä¸€ä¸ªæµ‹è¯•éƒ½æ— æ³•é€šè¿‡ï¼Œæ‰€ä»¥ç›®å‰æš‚æ—¶ä¸æ”¯æŒ regression test.

3. ä»¿çœŸç»“æœ
   riscv-tests æ±‡ç¼–æ–‡ä»¶ï¼Œé»˜è®¤æµ‹è¯•é€šè¿‡çš„æ—¶å€™ï¼Œx3 çš„å€¼ä¸º 1ï¼Œæ‰€ä»¥æ¯ä¸€è½®ä»¿çœŸç»“æŸä¹‹åï¼Œæˆ‘ä»¬åœ¨ testbench é‡Œæ£€æŸ¥
   x3 çš„å€¼å°±å¯ä»¥åˆ¤æ–­æµ‹è¯•æ˜¯å¦é€šè¿‡

   ![sim fail](https://s2.loli.net/2023/05/25/TcrkZPS9DbLeV8h.png)
