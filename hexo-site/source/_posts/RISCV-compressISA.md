---
title: RISC-VÂéãÁº©Êåá‰ª§ÈõÜ
date: 2023-04-10 19:58:24
tags: RISCV
---

![RV-32C](https://s2.loli.net/2023/04/10/C73opKyZbMJrktW.png)
RISC-V ÂéãÁº©Êåá‰ª§ÈõÜÂ≠¶‰π†Á¨îËÆ∞

<!--more-->

## RISC-V ÂéãÁº©Êåá‰ª§Âü∫Á°Ä

1. RV32I ‰ºöÂú®‰∏ãËø∞ÊÉÖÂÜµ‰∏ãÂéãÁº©Êåá‰ª§ÔºåÁîüÊàê RISC-V ÂéãÁº©Êåá‰ª§(RVC)

   1. imm, offset ÂæàÂ∞èÁöÑÊó∂ÂÄô
   2. register ÊòØ x0 ÊàñËÄÖ x2
   3. register ÊòØÂ∏∏Áî®ÁöÑÈÇ£ 8 ‰∏™: x8~x15
   4. rs1=rd

2. RVC ‰∏≠ÁöÑÊåá‰ª§Â§ßËá¥ÂèØ‰ª•ÂàÜ‰∏∫Â¶Ç‰∏ã‰∏âÁ±ª:

   1. Load and Store(4): `LW`, `SW`, `LWSP`, `SWSP`
   2. Control(6): `J`, `JAL`, `JR`, `JALR`, `BEQZ`, `BNEZ`
   3. Integer:
      - Register-Immediate(9): `LI`, `LUI`, `ADDI`, `ADDI16SP`, `ADDI4SPN`, `SLLI`, `SRLI`, `SRAI`, `ANDI`
      - Register-Register(6): `MV`, `AND`, `OR`, `XOR`, `SUB`, `ADD`
      - Others(3): `NOP`, `EBREAK`, `HINT`

3. RV-32IM ‰∏≠ÊúâÂØπÂ∫îÂéãÁº©Êåá‰ª§ÁöÑÊåá‰ª§

   | $opcode_{[6:2]}$ | RV-32I Êåá‰ª§                  |
   | ---------------- | ---------------------------- |
   | 01101            | LUI                          |
   | 01000            | SW                           |
   | 00000            | LW                           |
   | 00100            | ADDI, ANDI, SLLI, SRLI, SRAI |
   | 01100            | ADD, SUB, XOR, OR, AND,      |
   | 11001            | JALR                         |
   | 11011            | JAL                          |
   | 11000            | BEQ, BNE                     |
   | 11100            | EBREAK                       |

4. RV-32IM ‰∏≠Ê≤°ÊúâÂØπÂ∫îÂéãÁº©Êåá‰ª§ÁöÑÊåá‰ª§Ôºö

   | $opcode_{[6:2]}$ | RV-32IM Êåá‰ª§                                   |
   | ---------------- | ---------------------------------------------- |
   | 00101            | AUIPC                                          |
   | 01000            | SB, SH                                         |
   | 00000            | LB, BH, LBU, LHU                               |
   | 00100            | SLTI, SLTIU, XORI, ORI                         |
   | 01100            | SLT, SLTU, SLLI, SRLI, SRAI                    |
   | 11000            | BLT, BGE, BLTU, BGEU                           |
   | 01100            | MUL, MULH, MULHSU, MULHU, DIV, DIVU, REM, REMU |

## ÂéãÁº©Êåá‰ª§Ê†ºÂºè

### C.LW Ê†ºÂºè‰∏æ‰æã

1. `LW` for _load word_, ÊòØ`CL`Ê†ºÂºèÁöÑÂéãÁº©Êåá‰ª§
2. ÂäüËÉΩÔºö`x[8+rd‚Äô] = sext(M[x[8+rs1‚Äô] + uimm][31:0])`
3. Êâ©Â±ïÊàê 32bits Êåá‰ª§Ôºö`c.lw rd‚Äô,uimm(rs1‚Äô) --> lw rd‚Äô,offset[6:2](rs1‚Äô)`
   - imm Âç† 5bitsÔºåimm ‰πò 4Ôºå**Èõ∂Êâ©Â±ï**‰∏∫ 32bits
   - rs1'Âíå rd'ÈÉΩÊòØÂØÑÂ≠òÂô®ÁöÑ‰∏ãÊ†áÔºåÂè™Êúâ 3bitsÔºåÂÖ∂ÂèØ‰ª•Á¥¢Âºï x8~x15 ÁöÑÂØÑÂ≠òÂô®
4. Â∞Ü C.LW ÊãìÂ±ï‰∏∫ 32bits ÁöÑ LW Êåá‰ª§

   - Â∑≤Áü• C.LW Ê†ºÂºè

     | 15-13 | 12-10     | 9-7  | 6-5        | 4-2 | 1-0 |
     | ----- | --------- | ---- | ---------- | --- | --- |
     | 010   | uimm[5:3] | rs1' | uimm[2\|6] | rd' | 00  |

   - Â∑≤Áü• LW Ê†ºÂºè

     | 31-20  | 19-15 | 14-12 | 11-7 | 6-2   | 1-0 |
     | ------ | ----- | ----- | ---- | ----- | --- |
     | offset | rs1   | 010   | rd   | 00000 | 11  |

   - Áî® c Ë°®Á§∫ RVC Êåá‰ª§, i Ë°®Á§∫ RV32I Êåá‰ª§ÔºåÂàôÁî± c ÊãìÂ±ïÂæóÂà∞ i Á≠ñÁï•Â¶Ç‰∏ã

     | 31-20                            | 19-15         | 14-12 | 11-7          | 6-2      | 1-0   |
     | -------------------------------- | ------------- | ----- | ------------- | -------- | ----- |
     | 5'b0, c[5], c[12:10], c[5], 2'b0 | 2'b01, c[9:7] | 010   | 2'b01, c[4:2] | 5'b00000 | 2'b11 |

     `i={5'b0, c[5], c[12:10], c[5], 2'b0, 2'b01, c[9:7], 010, 2'b01, c[4:2] , 7'b0000011}`

Áî±‰∫é RVC Êåá‰ª§ÁöÑÊ†ºÂºè„ÄÅÂäüËÉΩÊØîËæÉÂõ∫ÂÆöÔºå‰∏îÂÆòÊñπÁöÑÊâãÂÜåÂ∑≤ÁªèËØ¥ÁöÑË∂≥Â§üÁ≤æÁÆÄ‰∫ÜÔºåÂõ†Ê≠§Êú¨ÊñáÊ°£‰∏çÂÜç‰∏ìÈó®ÈÄê‰∏ÄÊÄªÁªìÂÖ∂‰Ωô 26 Êù° RV32I Áõ∏ÂÖ≥ÁöÑ RVC Êåá‰ª§ÔºåËØ∑ÂèÇËÄÉ‰ª•‰∏ãÈìæÊé•Ëá™Ë°åÈòÖËØªÔºö

1. üåü[Official: ‚ÄúC‚Äù Standard Extension for Compressed Instructions, Version 2.0 ](https://five-embeddev.com/riscv-isa-manual/latest/c.html)
2. [RV32C, RV64C Instructions on riscv-isa-page](https://msyksphinz-self.github.io/riscv-isadoc/html/rvc.html)

### ÊÅ¢Â§çÊàê RV32I Êåá‰ª§

> RVC ÊÅ¢Â§çÊàê RV32I Êåá‰ª§ÁöÑÊó∂ÂÄôÔºåÈ¶ñÂÖàÊ†πÊçÆ op ÈÉ®ÂàÜÂØπÊåá‰ª§ËøõË°åÂàÜÁ±ªÔºåÂÜçÊ†πÊçÆ funct3 ÈÉ®ÂàÜÂØπÊåá‰ª§ÂàÜÁ±ª„ÄÇÂ¶ÇÊûúÂ§ö‰∏™Êåá‰ª§ op Âíå funct3 ÈÉΩÁõ∏ÂêåÔºåÂàôÈúÄË¶ÅËøõ‰∏ÄÊ≠•Ê†πÊçÆÂÖ∂ÂÆÉÂ≠óÊÆµÊù•Âå∫ÂàÜ‰ªñ‰ª¨

#### op=00

| ÂéãÁº©Êåá‰ª§ | op=inst[1:0] | funct3=inst[15:13] | ÂéãÁº©Êåá‰ª§Ê†ºÂºè | ÂØπÂ∫î 32I Êåá‰ª§               |
| -------- | ------------ | ------------------ | ------------ | --------------------------- |
| ADDI4SPN | 00           | 000                | CIW          | `addi rd‚Äô,x2,nzuimm`        |
| LW       | 00           | 010                | CL           | `lw rd‚Äô,offset[6:2](rs1‚Äô)`  |
| SW       | 00           | 110                | CS           | `sw rs2‚Äô,offset[6:2](rs1‚Äô)` |

op=00 Êó∂ÔºåÂ¶ÇÊûú funct3 ‰∏çÊòØ‰∏äËø∞ 3 ÁßçÊÉÖÂÜµÔºåÂàôÈÉΩÊòØÈùûÊ≥ïÂéãÁº©Êåá‰ª§

#### op=01

| ÂéãÁº©Êåá‰ª§ | op=inst[1:0] | funct3=inst[15:13] | ÂéãÁº©Êåá‰ª§Ê†ºÂºè | ÂØπÂ∫î 32I Êåá‰ª§             |
| -------- | ------------ | ------------------ | ------------ | ------------------------- |
| NOP      | 01           | 000                | CI           | `addi x0, x0, 0`          |
| ADDI     | 01           | 000                | CI           | `addi rd, rd, nzimm[5:0]` |
| JAL      | 01           | 001                | CJ           | `jal x1, offset[11:1]`    |
| LI       | 01           | 010                | CI           | `addi rd,x0,imm[5:0]`     |
| LUI      | 01           | 011                | CI           | `lui rd,nzuimm[17:12]`    |
| ADDI16SP | 01           | 011                | CI           | `addi x2,x2, nzimm[9:4]`  |
| SRLI     | 01           | 100000             | CB           | `srli rd‚Äô,rd‚Äô,shamt[5:0]` |
| SRAI     | 01           | 100001             | CB           | `srai rd‚Äô,rd‚Äô,shamt[5:0]` |
| ANDI     | 01           | 100x10             | CB           | `andi rd‚Äô,rd‚Äô,imm[5:0]`   |
| SUB      | 01           | 100011             | CA           | `sub rd‚Äô,rd‚Äô,rs2‚Äô`        |
| XOR      | 01           | 100011             | CA           | `xor rd‚Äô,rd‚Äô,rs2‚Äô`        |
| OR       | 01           | 100011             | CA           | `or rd‚Äô,rd‚Äô,rs2`          |
| AND      | 01           | 100011             | CA           | `and rd‚Äô,rd‚Äô,rs2‚Äô`        |
| J        | 01           | 101                | CJ           | `jal x0,offset[11:1]`     |
| BEQZ     | 01           | 110                | CB           | `beq rs1‚Äô,x0,offset[8:1]` |
| BNEZ     | 01           | 111                | CB           | `bne rs1‚Äô,x0,offset[8:1]` |

#### op==10

| ÂéãÁº©Êåá‰ª§ | op=inst[1:0] | funct3=inst[15:13] | ÂéãÁº©Êåá‰ª§Ê†ºÂºè | ÂØπÂ∫î 32I Êåá‰ª§            |
| -------- | ------------ | ------------------ | ------------ | ------------------------ |
| SLLI     | 10           | 000                | CI           | `slli rd,rd,shamt[5:0]`  |
| LWSP     | 10           | 010                | CI           | `lw rd,offset[7:2](x2)`  |
| MV       | 10           | 1000               | CR           | `add rd, x0, rs2`        |
| JR       | 10           | 1000               | CR           | `jalr x0,rs1,0`          |
| ADD      | 10           | 1001               | CR           | `add rd,rd,rs2`          |
| EBREAK   | 10           | 1001               | CR           | `ebreak`                 |
| JALR     | 10           | 1001               | CR           | `jalr x1,rs1,0`          |
| SWSP     | 10           | 110                | CSS          | `sw rs2,offset[7:2](x2)` |

## üåü Ê†ºÂºèÁõ∏‰ººÁöÑÊåá‰ª§

1. `SRLI`„ÄÅ`SRAI`Âíå`ANDI`[11:10]:
   - `SRLI`: 00
   - `SRAI`: 01
   - `ANDI`: 10
2. `J`Âíå`JAL`Âè™Êúâ inst[15]‰∏ç‰∏ÄÊ†∑
3. `JR`Âíå`JALR`Âè™Êúâ inst[12]‰∏ç‰∏ÄÊ†∑
4. `BNEZ`Âíå`BEQZ`Âè™Êúâ inst[13]‰∏ç‰∏ÄÊ†∑

## üåü ÈùûÊ≥ïÊåá‰ª§(illegal instruction)

1. `ADDI4SPN`: $imm == 0$, Ë¢´‰øùÁïô‰∫Ü(reserved)
2. `LUI`: $imm == 0$, reserved
3. `ADDI16SP`: $imm == 0$, reserved
4. `SLLI`„ÄÅ`SRLI`Âíå`SRAI`: $imm5=inst[12]==1$ÔºåÂØºËá¥Áßª‰ΩçË∂ÖËøá‰∫Ü 31bits
5. `LWSP`: $rd=inst[11:7]=x0$, reserved
6. `JR`:$rs1 == x0$, `JR`ÂÖ∂ offset ÊÅí‰∏∫ 0ÔºåËã• rs1 ËøòÁ≠â‰∫é x0, ÂàôË∑≥ËΩ¨ PC Â∞±ÊòØÂΩìÂâçÁöÑ PC
7. ÂÖ∂‰ªñÊú™ÂÆö‰πâÁöÑÂéãÁº©Êåá‰ª§‰πüÈÉΩÊòØ illegal instruction

## üåü RVC ÁöÑ imm Â¶Ç‰ΩïÊãìÂ±ï‰∏∫ÂØπÂ∫î RV32I ÁöÑ imm

1. Á´ãÂç≥Êï∞ÂÅöÈõ∂Êâ©Â±ï (zero-extend imm): `SLLI`, `ADDI4SPN`, `SRLI`, `SRAI`, `SW`, `LW`, `LWSP`, `SWSP`;  
   Á´ãÂç≥Êï∞ÂÅöÁ¨¶Âè∑ÊãìÂ±ï (sign-extend imm): Others

   > RVC ‰∏≠ÁöÑ imm ÁöÑ‰ΩçÂÆΩ‰ºöÊØî RV32I Êåá‰ª§‰∏≠ÁöÑ imm ‰ΩçÂÆΩÂ∞èÔºåÂõ†Ê≠§ÈúÄË¶ÅÊâ©Â±ï‰∏∫ÂØπÂ∫îÁöÑ‰ΩçÂÆΩ.

2. imm Â∑¶Áßª‰ΩçÊï∞

   - 1: `J`, `JAL`,`BEQZ`, `BNEZ`
   - 2: `ADDI4SPN`, `LW`, `SW`, `LWSP`, `SWSP`
   - 4: `ADDI16SP`
   - 12: `LUI`

   > RVC ‰∏≠ÁöÑ imm ÊãìÂ±ïÂà∞ RV32I ‰∏≠ÁöÑÁ´ãÂç≥Êï∞ÁöÑÊó∂ÂÄôÔºå‰ºöÊúâ‰∏Ä‰∏™ÊîæÂ§ßÔºàscaleÔºâÂÄçÊï∞ÔºåÈúÄË¶ÅÂØπÂÖ∂ imm ËøõË°åÂ∑¶Áßª

## ÂèòÊàêÂÖ∂‰ªñÂéãÁº©Êåá‰ª§(change to other RVC instruction)

1. `ADDI`: Â¶ÇÊûú$rd==x0$, Âàô`ADDI -> NOP`
2. `LUI`: Â¶ÇÊûú$rd=x2$, Âàô`LUI -> ADDI16SP`
3. `MV`: Â¶ÇÊûú$rs2=x0$, Âàô`MV -> JR`
4. `ADD`: Â¶ÇÊûú$rs2=x0$, Âàô`ADD -> EBREAK`
5. `JALR`: Â¶ÇÊûú$rs1==x0$, Âàô`JALR -> EBREAK`

## HINTs instruction

> HINTs Êåá‰ª§ÂäüËÉΩÁ±ª‰ºº‰∫é nop Êåá‰ª§ÔºåÂÆÉÈô§‰∫ÜÂ¢ûÂä† PC ÊàñËÄÖÂÖ∂‰ªñ counter ‰πãÂ§ñ‰∏ç‰ºöÂØπÁ≥ªÁªü‰∫ßÁîü‰ªª‰ΩïÂΩ±Âìç, ‰∏çÁî®Âú®ÂæÆÊû∂ÊûÑÈáåÂÆûÁé∞ HINTs Êåá‰ª§

1. `NOP`Âíå`ADDI`: $imm==0$
2. `LI`, `LUI`: $rd==x0$
3. `SLLI`, `SRLI`Âíå`SRAI`: $rd==x0$ ÊàñËÄÖ$imm==0$

## RVC Êåá‰ª§ÊãìÂ±ïÊàê RV32I ÂÖ∑‰ΩìÊñπÊ≥ï

| ÂéãÁº©Êåá‰ª§   | ÊÅ¢Â§çÊàê RV32I Êåá‰ª§ÁöÑÊñπÊ≥ï                                                                       | illegal ÊÉÖÂÜµ         |
| ---------- | --------------------------------------------------------------------------------------------- | -------------------- |
| ADDI4SPN   | `i={2'b0,c[10:7],c[12:11],c[5],c[6],2'b00,5'h02,3'b000,2'b01,c[4:2],5'b00100,2'b11};        ` | `c[12:5] == 8'b0`    |
| LW         | `i={5'b0,c[5],c[12:10],c[6],2'b00,2'b01,c[9:7],3'b010,2'b01,c[4:2],7'b0000011}};            ` |                      |
| SW         | `i={5'b0,c[5],c[12],2'b01,c[4:2],2'b01,c[9:7],3'b010,c[11:10],c[6],2'b00,7'b0100011};       ` |                      |
| ADDI, NOP  | `i={{6{c[12]}},c[12],c[6:2],c[11:7],3'b0,c[11:7],7'b0010011};                               ` |                      |
| J, JAL     | `i={c[12],c[8],c[10:9],c[6],c[7],c[2],c[11],c[5:3],{9{c[12]}},4'b0,~c[15],7'b1101111};      ` |                      |
| LI         | `i={{6{c[12]}},c[12],c[6:2],5'b0,3'b0,c[11:7],7'b0010011};                                  ` |                      |
| LUI        | `i={{15{c[12]}},c[6:2],c[11:7],7'b0110111};                                                 ` | {c[12],c[6:2]}==6'b0 |
| ADDI16SP   | `i={{3{c[12]}},c[4:3],c[5],c[2],c[6],4'b0,5'h02,3'b000,5'h02,7'b0010011};                   ` | {c[12],c[6:2]}==6'b0 |
| SRLI, SRAI | `i={1'b0,c[10],5'b0,c[6:2],2'b01,c[9:7],3'b101,2'b01,c[9:7],7'b0010011};                    ` | c[12]=1'b1           |
| ANDI       | `i={{6{c[12]}},c[12],c[6:2],2'b01,c[9:7],3'b111,2'b01,c[9:7],7'b0010011};                   ` |                      |
| SUB        | `i={2'b01,5'b0,2'b01,c[4:2],2'b01,c[9:7],3'b000,2'b01,c[9:7],7'b0110011};                   ` |                      |
| XOR        | `i={7'b0,2'b01,c[4:2],2'b01,c[9:7],3'b100,2'b01,c[9:7],7'b0110011};                         ` |                      |
| OR         | `i={7'b0,2'b01,c[4:2],2'b01,c[9:7],3'b110,2'b01,c[9:7],7'b0110011};                         ` |                      |
| AND        | `i={7'b0,2'b01,c[4:2],2'b01,c[9:7],3'b111,2'b01,c[9:7],7'b0110011};                         ` |                      |
| BEQZ, BNEZ | `i={{4{c[12]}},c[6:5],c[2],5'b0,2'b01,c[9:7],2'b00,c[13],c[11:10],c[4:3],c[12],7'b1100011}; ` |                      |
| SLLI       | `i={7'b0,c[6:2],c[11:7],3'b001,c[11:7],7'b0010011};                                         ` | c[12]=1'b1           |
| LWSP       | `i={4'b0,c[3:2],c[12],c[6:4],2'b00,5'h02,3'b010,c[11:7],7'b0000011};                        ` | c[11:7]=5'b0         |
| MV         | `i={7'b0,c[6:2],5'b0,3'b0,c[11:7],7'b0110011};                                              ` |                      |
| JR         | `i={12'b0,c[11:7],3'b0,5'b0,7'b1100111};                                                    ` | c[11:7]=5'b0         |
| ADD        | `i={7'b0,c[6:2],c[11:7],3'b0,c[11:7],7'b0110011};                                           ` |                      |
| JALR       | `i={12'b0,c[11:7],3'b000,5'b00001,7'b1100111};                                              ` |                      |
| EBREAK     | `i={32'h00_10_00_73};                                                                       ` |                      |
| SWSP       | `i={4'b0,c[8:7],c[12],c[6:2],5'h02,3'b010,c[11:9],2'b00,7'b0100011};                        ` |                      |

<div STYLE="page-break-after: always;"></div>
![rvc](/Users/fujie/Pictures/typora/rvc.svg)
