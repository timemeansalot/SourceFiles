<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="network,">





  <link rel="alternate" href="/atom.xml" title="timemeansalot" type="application/atom+xml">






<meta name="description" content="My Notes about internet frame format like ethernet、TCP/IP [[TOC]]">
<meta name="keywords" content="network">
<meta property="og:type" content="article">
<meta property="og:title" content="internet_protocol_format">
<meta property="og:url" content="http://timemeansalot.gitee.io/2021/03/23/internet-protocol-format/index.html">
<meta property="og:site_name" content="timemeansalot">
<meta property="og:description" content="My Notes about internet frame format like ethernet、TCP/IP [[TOC]]">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2021/03/23/LxeoRtiha7EB9DO.png">
<meta property="og:image" content="https://i.loli.net/2021/03/23/W9tnLeNuXxIqwM6.png">
<meta property="og:image" content="https://i.loli.net/2021/03/23/O4kQyCZr721e9Es.png">
<meta property="og:image" content="https://i.loli.net/2021/03/23/cEn4uQxSar6J5Hy.png">
<meta property="og:image" content="https://i.loli.net/2021/03/23/Kwc3TmjHFEuQoy4.png">
<meta property="og:image" content="https://i.loli.net/2021/03/23/3vy8Gn6QpfLNOe1.png">
<meta property="og:updated_time" content="2021-04-11T08:32:47.554Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="internet_protocol_format">
<meta name="twitter:description" content="My Notes about internet frame format like ethernet、TCP/IP [[TOC]]">
<meta name="twitter:image" content="https://i.loli.net/2021/03/23/LxeoRtiha7EB9DO.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://timemeansalot.gitee.io/2021/03/23/internet-protocol-format/">







  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "4a702b6a"
    });
  daovoice('update');
  </script>

  <title>internet_protocol_format | timemeansalot</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">


  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/abetterus?tab=repositories" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#FD6C6C; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">timemeansalot</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力、奋斗</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://timemeansalot.gitee.io/2021/03/23/internet-protocol-format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FuJie">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://s2.ax1x.com/2019/03/19/AuQxUJ.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="timemeansalot">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">internet_protocol_format</h1>
        

        <div class="post-meta">

          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-23T13:25:44+08:00">
                2021-03-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2021/03/23/internet-protocol-format/" class="leancloud_visitors" data-flag-title="internet_protocol_format">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>My Notes about internet frame format like <code>ethernet</code>、<code>TCP/IP</code></p>
<p>[[<em>TOC</em>]]</p>
<a id="more"></a>
<h1 id="L2-LinkLayer"><a href="#L2-LinkLayer" class="headerlink" title="L2 LinkLayer"></a>L2 LinkLayer</h1><h2 id="Ethernet-2"><a href="#Ethernet-2" class="headerlink" title="Ethernet 2"></a>Ethernet 2</h2><p>DMAC 48b;SMAC 48b</p>
<p>ethernet type: 16b</p>
<h2 id="802-1q-ad"><a href="#802-1q-ad" class="headerlink" title="802.1q/ad"></a>802.1q/ad</h2><p>tag format:</p>
<p><img src="https://i.loli.net/2021/03/23/LxeoRtiha7EB9DO.png" alt="image-20210323092527183"></p>
<ol>
<li>TPID 16b: tag protocol identifier, always 0x8100 to identify it’s a 802.1q tagged frame</li>
<li>TCI 16b: tag control information<ul>
<li>PCP 3b: priority code point, identify frame priority level</li>
<li>DEI 1b: drop eligible indicator, to indicate frames eligible to be dropped in the presence of congestion</li>
<li>VID 12b: VLAN identifier</li>
</ul>
</li>
</ol>
<p>802.1ad introduced the concept of double tagging: there is two tags: 0x88a8, 0x8100</p>
<h2 id="802-3"><a href="#802-3" class="headerlink" title="802.3"></a>802.3</h2><h2 id="LLC"><a href="#LLC" class="headerlink" title="LLC"></a>LLC</h2><h2 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h2><h2 id="MPLS"><a href="#MPLS" class="headerlink" title="MPLS"></a>MPLS</h2><p><strong>Multiprotocol Label Switching</strong> (<strong>MPLS</strong>) is a routing technique in <a href="https://en.wikipedia.org/wiki/Telecommunications_network" target="_blank" rel="noopener">telecommunications networks</a> that directs data from one <a href="https://en.wikipedia.org/wiki/Node_(networking" target="_blank" rel="noopener">node</a>) to the next <code>based on short path labels rather than long network addresses</code>, thus avoiding complex lookups in a <a href="https://en.wikipedia.org/wiki/Routing_table" target="_blank" rel="noopener">routing table</a> and speeding traffic flows</p>
<p><img src="https://i.loli.net/2021/03/23/W9tnLeNuXxIqwM6.png" alt="image-20210323105006216"></p>
<ul>
<li>A 20-bit label value. A label with the value of 1 represents the <a href="https://en.wikipedia.org/wiki/Router_alert_label" target="_blank" rel="noopener">router alert label</a>.</li>
<li>a 3-bit <em>Traffic Class</em> field for QoS (<a href="https://en.wikipedia.org/wiki/Quality_of_service" target="_blank" rel="noopener">quality of service</a>) priority and ECN (<a href="https://en.wikipedia.org/wiki/Explicit_Congestion_Notification" target="_blank" rel="noopener">Explicit Congestion Notification</a>). Prior to 2009 this field was called EXP.<a href="https://en.wikipedia.org/wiki/Multiprotocol_Label_Switching#cite_note-9" target="_blank" rel="noopener">[9]</a></li>
<li>a 1-bit <em>bottom of stack</em> flag. If this is set, it signifies that the current label is the last in the stack.</li>
<li>an 8-bit TTL (<a href="https://en.wikipedia.org/wiki/Time_to_live" target="_blank" rel="noopener">time to live</a>) field.</li>
</ul>
<h1 id="L3-NetworkLayer"><a href="#L3-NetworkLayer" class="headerlink" title="L3 NetworkLayer"></a>L3 NetworkLayer</h1><h2 id="IPv4"><a href="#IPv4" class="headerlink" title="IPv4"></a>IPv4</h2><p>packet format：</p>
<p><img src="https://i.loli.net/2021/03/23/O4kQyCZr721e9Es.png" alt="image-20210323093146792"></p>
<ol>
<li>version(4b): always equal to 4 to identify its an ipv4 datagram</li>
<li>IHL(4b): size of IPv4 header, unit is 4B; </li>
<li>DSCP(6b): Typs of service</li>
<li>ECN(2b): explicit congestion notification</li>
<li>Totol Lenght(16b): entire packet size in bytes, unit is 1B</li>
<li>Identification(16b): identify the group of fragments of a single IP datagram, IP message can be splited to fragments when transferring on L2</li>
<li>Flags(3b): A three-bit field follows and is used to control or identify fragments</li>
<li>Fragment Offset(12b): The fragment offset field is measured in units of eight-byte blocks , unit is 8B</li>
<li>TTL(8b): time to live, prevent datagrams from persisting</li>
<li>Protocol(8b): identify witch Transferring protocol is running. 0x11 for UDP, 0x06 for TCP</li>
<li>Header Checksum(16b): is used for error-checking of the header</li>
<li>Options: often not used and should be an integer multiple of 4B</li>
</ol>
<h2 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h2><p>packet format: </p>
<p><img src="https://i.loli.net/2021/03/23/cEn4uQxSar6J5Hy.png" alt="image-20210323094523253"></p>
<p><strong><em>Version</em> (4 bits)</strong></p>
<p>The constant 6 (bit sequence <code>0110</code>).</p>
<p><strong><em>Traffic Class</em> (6+2 bits)</strong></p>
<p>The bits of this field hold two values. The six most-significant bits hold the <a href="https://en.wikipedia.org/wiki/Differentiated_services_field" target="_blank" rel="noopener">differentiated services field</a> (DS field), which is used to classify packets.<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc2474-2" target="_blank" rel="noopener">[2]</a><a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc3260-3" target="_blank" rel="noopener">[3]</a> Currently, all standard DS fields end with a ‘0’ bit. Any DS field that ends with two ‘1’ bits is intended for local or experimental use.<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc4727-4" target="_blank" rel="noopener">[4]</a></p>
<p>The remaining two bits are used for <a href="https://en.wikipedia.org/wiki/Explicit_Congestion_Notification" target="_blank" rel="noopener">Explicit Congestion Notification</a> (ECN);<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc3168-5" target="_blank" rel="noopener">[5]</a> priority values subdivide into ranges: traffic where the source provides congestion control and non-congestion control traffic.</p>
<p><strong><em>Flow Label</em> (20 bits)</strong></p>
<p>A high-entropy identifier of a flow of packets between a source and destination. A flow is a group of packets, e.g., a TCP session or a media stream. The special flow label 0 means the packet does not belong to any flow (using this scheme). An older scheme identifies flow by source address and port, destination address and port, protocol (value of the last <em>Next Header</em> field).<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc6437-6" target="_blank" rel="noopener">[6]</a> It has further been suggested that the flow label be used to help detect spoofed packets.<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-7" target="_blank" rel="noopener">[7]</a></p>
<p><strong><em>Payload Length</em> (16 bits)</strong></p>
<p>The size of the payload in octets, including any extension headers. The length is set to zero when a <em>Hop-by-Hop</em> extension header carries a <a href="https://en.wikipedia.org/wiki/IPv6_packet#Jumbogram" target="_blank" rel="noopener">Jumbo Payload</a> option.<a href="https://en.wikipedia.org/wiki/IPv6_packet#cite_note-rfc2675-8" target="_blank" rel="noopener">[8]</a></p>
<p><strong><em>Next Header</em> (8 bits)</strong></p>
<p>Specifies the type of the next header. This field usually specifies the <a href="https://en.wikipedia.org/wiki/Transport_layer" target="_blank" rel="noopener">transport layer</a> protocol used by a packet’s payload. When extension headers are present in the packet this field indicates which extension header follows. The values are shared with those used for the IPv4 protocol field, as both fields have the same function (see <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers" target="_blank" rel="noopener">List of IP protocol numbers</a>).</p>
<p><strong><em>Hop Limit</em> (8 bits)</strong></p>
<p>Replaces the <a href="https://en.wikipedia.org/wiki/Time_to_live" target="_blank" rel="noopener">time to live</a> field in IPv4. This value is decremented by one at each forwarding node and the packet is discarded if it becomes 0. However, the destination node should process the packet normally even if received with a hop limit of 0.</p>
<p><strong><em>Source Address</em> (128 bits)</strong></p>
<p>The unicast <a href="https://en.wikipedia.org/wiki/IPv6_address" target="_blank" rel="noopener">IPv6 address</a> of the sending node.</p>
<p><strong><em>Destination Address</em> (128 bits)</strong></p>
<p>The IPv6 unicast or multicast address of the destination node(s).</p>
<h1 id="L4-TransportLayer"><a href="#L4-TransportLayer" class="headerlink" title="L4 TransportLayer"></a>L4 TransportLayer</h1><h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p>datagram format:</p>
<p><img src="https://i.loli.net/2021/03/23/Kwc3TmjHFEuQoy4.png" alt="image-20210323101047873"></p>
<p><strong>Source port number</strong></p>
<p>This field identifies the sender’s port, when used, and should be assumed to be the port to reply to if needed. If not used, it should be zero. If the source host is the client, the port number is likely to be an ephemeral port number. If the source host is the server, the port number is likely to be a <a href="https://en.wikipedia.org/wiki/Well-known_port" target="_blank" rel="noopener">well-known port</a> number.<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-forouzan-4" target="_blank" rel="noopener">[4]</a></p>
<p><strong>Destination port number</strong></p>
<p>This field identifies the receiver’s port and is required. Similar to source port number, if the client is the destination host then the port number will likely be an ephemeral port number and if the destination host is the server then the port number will likely be a well-known port number.<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-forouzan-4" target="_blank" rel="noopener">[4]</a></p>
<p><strong>Length</strong></p>
<p>This field specifies the length <code>in bytes</code> of the UDP header and UDP data. The minimum length is 8 bytes, the length of the header. The field size sets a theoretical limit of 65,535 bytes (8 byte header + 65,527 bytes of data) for a UDP datagram. However the actual limit for the data length, which is imposed by the underlying <a href="https://en.wikipedia.org/wiki/IPv4" target="_blank" rel="noopener">IPv4</a> protocol, is 65,507 bytes (65,535 − 8 byte UDP header − 20 byte <a href="https://en.wikipedia.org/wiki/IPv4_header" target="_blank" rel="noopener">IP header</a>).<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-forouzan-4" target="_blank" rel="noopener">[4]</a></p>
<p>Using IPv6 <a href="https://en.wikipedia.org/wiki/Jumbogram" target="_blank" rel="noopener">jumbograms</a> it is possible to have UDP datagrams of size greater than 65,535 bytes.<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-5" target="_blank" rel="noopener">[5]</a> <a href="https://en.wikipedia.org/wiki/RFC_(identifier" target="_blank" rel="noopener">RFC</a>) <a href="https://tools.ietf.org/html/rfc2675" target="_blank" rel="noopener">2675</a> specifies that the length field is set to zero if the length of the UDP header plus UDP data is greater than 65,535.</p>
<p><strong>Checksum</strong></p>
<p>The <a href="https://en.wikipedia.org/wiki/Checksum" target="_blank" rel="noopener">checksum</a> field may be used for error-checking of the header and data. This field is optional in IPv4, and mandatory in IPv6.<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-rfc2460-6" target="_blank" rel="noopener">[6]</a> The field carries all-zeros if unused.<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol#cite_note-rfc768-7" target="_blank" rel="noopener">[7]</a></p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>tcp segment header format</p>
<p><img src="https://i.loli.net/2021/03/23/3vy8Gn6QpfLNOe1.png" alt="image-20210323101614270"></p>
<ul>
<li><p><strong>Source port (16 bits)</strong></p>
<p>Identifies the sending port.</p>
</li>
<li><p><strong>Destination port (16 bits)</strong></p>
<p>Identifies the receiving port.</p>
</li>
<li><p><strong>Sequence number (32 bits)</strong></p>
<p>Has a dual role:If the SYN flag is set (1), then this is the initial sequence number. The sequence number of the actual first data byte and the acknowledged number in the corresponding ACK are then this sequence number plus 1.If the SYN flag is clear (0), then this is the accumulated sequence number of the first data byte of this segment for the current session.</p>
</li>
<li><p><strong>Acknowledgment number (32 bits)</strong></p>
<p>If the ACK flag is set then the value of this field is the next sequence number that the sender of the ACK is expecting. This acknowledges receipt of all prior bytes (if any). The first ACK sent by each end acknowledges the other end’s initial sequence number itself, but no data.</p>
</li>
<li><p><strong>Data offset (4 bits)</strong></p>
<p>Specifies the size of the TCP header in 32-bit <a href="https://en.wikipedia.org/wiki/Word_(computer_architecture" target="_blank" rel="noopener">words</a>). The minimum size header is 5 words and the maximum is 15 words thus giving the minimum size of 20 bytes and maximum of 60 bytes, allowing for up to 40 bytes of options in the header. This field gets its name from the fact that it is also the offset from the start of the TCP segment to the actual data.</p>
</li>
<li><p><strong>Reserved (3 bits)</strong></p>
<p>For future use and should be set to zero.</p>
</li>
<li><p><strong>Flags (9 bits)</strong></p>
<p>Contains 9 1-bit flags (control bits) as follows:NS (1 bit): ECN-nonce - concealment protection<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-10" target="_blank" rel="noopener">[a]</a>CWR (1 bit): Congestion window reduced (CWR) flag is set by the sending host to indicate that it received a TCP segment with the ECE flag set and had responded in congestion control mechanism.<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-added3168-11" target="_blank" rel="noopener">[b]</a>ECE (1 bit): ECN-Echo has a dual role, depending on the value of the SYN flag. It indicates:If the SYN flag is set (1), that the TCP peer is <a href="https://en.wikipedia.org/wiki/Explicit_Congestion_Notification" target="_blank" rel="noopener">ECN</a> capable.If the SYN flag is clear (0), that a packet with Congestion Experienced flag set (ECN=11) in the IP header was received during normal transmission.<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-added3168-11" target="_blank" rel="noopener">[b]</a> This serves as an indication of network congestion (or impending congestion) to the TCP sender.URG (1 bit): Indicates that the Urgent pointer field is significantACK (1 bit): Indicates that the Acknowledgment field is significant. All packets after the initial SYN packet sent by the client should have this flag set.PSH (1 bit): Push function. Asks to push the buffered data to the receiving application.RST (1 bit): Reset the connectionSYN (1 bit): Synchronize sequence numbers. Only the first packet sent from each end should have this flag set. Some other flags and fields change meaning based on this flag, and some are only valid when it is set, and others when it is clear.FIN (1 bit): Last packet from sender</p>
</li>
<li><p><strong>Window size (16 bits)</strong></p>
<p>The size of the <em>receive window</em>, which specifies the number of window size units<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-12" target="_blank" rel="noopener">[c]</a> that the sender of this segment is currently willing to receive.<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-13" target="_blank" rel="noopener">[d]</a> (See <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Flow_control" target="_blank" rel="noopener">§ Flow control</a> and <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Window_scaling" target="_blank" rel="noopener">§ Window scaling</a>.)</p>
</li>
<li><p><strong>Checksum (16 bits)</strong></p>
<p>The 16-bit <a href="https://en.wikipedia.org/wiki/Checksum" target="_blank" rel="noopener">checksum</a> field is used for error-checking of the TCP header, the payload and an IP pseudo-header. The pseudo-header consists of the <a href="https://en.wikipedia.org/wiki/IPv4#Source_address" target="_blank" rel="noopener">source IP address</a>, the <a href="https://en.wikipedia.org/wiki/IPv4#Destination_address" target="_blank" rel="noopener">destination IP address</a>, the <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers" target="_blank" rel="noopener">protocol number</a> for the TCP protocol (6) and the length of the TCP headers and payload (in bytes).</p>
</li>
<li><p><strong>Urgent pointer (16 bits)</strong></p>
<p>If the URG flag is set, then this 16-bit field is an offset from the sequence number indicating the last urgent data byte.</p>
</li>
<li><p><strong>Options (Variable 0–320 bits, in units of 32 bits)</strong></p>
<p>The length of this field is determined by the <em>data offset</em> field. Options have up to three fields: Option-Kind (1 byte), Option-Length (1 byte), Option-Data (variable). The Option-Kind field indicates the type of option and is the only field that is not optional. Depending on Option-Kind value, the next two fields may be set. Option-Length indicates the total length of the option, and Option-Data contains data associated with the option, if applicable. For example, an Option-Kind byte of 1 indicates that this is a no operation option used only for padding, and does not have an Option-Length or Option-Data fields following it. An Option-Kind byte of 0 marks the end Of options, and is also only one byte. An Option-Kind byte of 2 is used to indicate Maximum Segment Size option, and will be followed by an Option-Length byte specifying the length of the MSS field. Option-Length is the total length of the given options field, including Option-Kind and Option-Length fields. So while the MSS value is typically expressed in two bytes, Option-Length will be 4. As an example, an MSS option field with a value of 0x05B4 is coded as (0x02 0x04 0x05B4) in the TCP options section.</p>
<p>Some options may only be sent when SYN is set; they are indicated below as <code>[SYN]</code>. Option-Kind and standard lengths given as (Option-Kind, Option-Length).</p>
</li>
</ul>
<h1 id="L5ApplicationLayer"><a href="#L5ApplicationLayer" class="headerlink" title="L5ApplicationLayer"></a>L5ApplicationLayer</h1>
      
    </div>
    
    
    

    

    <div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束,感谢您的阅读-------------</div>
    
</div>
  
</div>

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/network/" rel="tag"><i class="fa fa-tag"></i> network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/16/hexo-setup/" rel="next" title="hexo搭建博客">
                <i class="fa fa-chevron-left"></i> hexo搭建博客
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/23/wsl-config/" rel="prev" title="wsl_config">
                wsl_config <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://s2.ax1x.com/2019/03/19/AuQxUJ.jpg" alt="FuJie">
            
              <p class="site-author-name" itemprop="name">FuJie</p>
              <p class="site-description motion-element" itemprop="description">一定很牛逼的我们</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:dtsmallangel@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/50771145" target="_blank" title="哔哩哔哩">
                      
                        <i class="fa fa-fw fa-tv"></i>哔哩哔哩</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/5855697347/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
            </div>
          

          
          

          
    
      <div class="links-of-blogroll motion-element links-of-blogroll-inline">
        <div class="links-of-blogroll-title">
          <i class="fa  fa-fw fa-link"></i>
          推荐阅读&nbsp;
          <i class="fa  fa-fw fa-link"></i>
        </div>
        <ul class="links-of-blogroll-list">
          
            <li class="links-of-blogroll-item">
              <a href="https://abetterus.github.io/2019/03/10/Diary/" title="每日趣事" target="_blank">每日趣事</a>
            </li>
          
            <li class="links-of-blogroll-item">
              <a href="https://abetterus.github.io/about/" title="自我介绍" target="_blank">自我介绍</a>
            </li>
          
        </ul>
         
<div id="days"></div>

<script language="javascript">
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("12/4/2018 00:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=setzero(Math.floor(e_hrsold));
e_minsold=(e_hrsold-hrsold)*60;
minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
seconds=setzero(Math.floor((e_minsold-minsold)*60));
document.getElementById('days').innerHTML="在一起"+daysold+"天"+hrsold+"时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
if (i<10)
{i="0" + i};
return i;
}
show_date_time();
</script>

      </div>
     


          
<div id="days"></div>

<script language="javascript">
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("12/4/2018 00:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=setzero(Math.floor(e_hrsold));
e_minsold=(e_hrsold-hrsold)*60;
minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
seconds=setzero(Math.floor((e_minsold-minsold)*60));
document.getElementById('days').innerHTML="在一起"+daysold+"天"+hrsold+"时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
if (i<10)
{i="0" + i};
return i;
}
show_date_time();
</script>

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#L2-LinkLayer"><span class="nav-number">1.</span> <span class="nav-text">L2 LinkLayer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ethernet-2"><span class="nav-number">1.1.</span> <span class="nav-text">Ethernet 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#802-1q-ad"><span class="nav-number">1.2.</span> <span class="nav-text">802.1q/ad</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#802-3"><span class="nav-number">1.3.</span> <span class="nav-text">802.3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLC"><span class="nav-number">1.4.</span> <span class="nav-text">LLC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ARP"><span class="nav-number">1.5.</span> <span class="nav-text">ARP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MPLS"><span class="nav-number">1.6.</span> <span class="nav-text">MPLS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#L3-NetworkLayer"><span class="nav-number">2.</span> <span class="nav-text">L3 NetworkLayer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv4"><span class="nav-number">2.1.</span> <span class="nav-text">IPv4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv6"><span class="nav-number">2.2.</span> <span class="nav-text">IPv6</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#L4-TransportLayer"><span class="nav-number">3.</span> <span class="nav-text">L4 TransportLayer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#UDP"><span class="nav-number">3.1.</span> <span class="nav-text">UDP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP"><span class="nav-number">3.2.</span> <span class="nav-text">TCP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#L5ApplicationLayer"><span class="nav-number">4.</span> <span class="nav-text">L5ApplicationLayer</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

      
<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="250" height="250" id="resCanvas" style="width=100%">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Birthday/">Birthday</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compile-Link/">Compile&Link</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Diary/">Diary</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LinkLayer/">LinkLayer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QinQ/">QinQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCAM/">TCAM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apps/">apps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardware/">hardware</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/imformal-essay/">imformal_essay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plan/">plan</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wsl/">wsl</a><span class="tag-list-count">1</span></li></ul>
        </canvas>
    </div>
</div>


    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FuJie</span>

  

    <!--<span class="post-meta-divider">|</span>-->
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">98k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



-->

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("JlmmlgLIdm5LThhukAGumE8H-9Nh9j0Va", "kwjFB7kySUc6WoCKd9e9r2Tb");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
